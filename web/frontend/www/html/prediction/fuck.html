<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>手机用户分析系统</title>
  <link rel="stylesheet" href="/static/layui/css/layui.css" >
  <link rel="stylesheet" href="/static/bootstrap/bootstrap.min.css">
</head>
<body  class="container">
        <form class="layui-form layui-row" action="">
                <div class="layui-form-item layui-col-md6 layui-col-md-offset3 ">
                        <label class="layui-form-label">已训练数据集</label>
                        <div class="layui-input-block">
                            <select id="trained" class="form-control input-sm" name="category0" lay-filter="category0" aria-invalid="false">
                            </select>
                        </div>
                    </div> 
        </form>
        <form id="upload_form" enctype="multipart/form-data">
            
            <div class="layui-form-item layui-col-md6 layui-col-md-offset3 ">
                    <label class="layui-form-label">预测数据集</label>
                    <label id="data_all_name" onclick="file_click('data_all')" class="btn btn-default layui-col-md8 layui-col-md-offset1">点击上传</label>
                    <input type="file" name="data_all" id="data_all" style="display: none;" />
            </div> 
            <input type="text" name="collection" id="collection" required="required">
        </form>
    <!-- <form class="layui-form layui-row" id="upload_form" enctype="multipart/form-data">  
        
             
        </div>      
       
     </form> -->
     <button class="btn btn-default  layui-col-md-offset4" onclick="pred()">确定</button>
     <!-- <button class="btn btn-default  layui-col-md-offset1" onclick="get_data()">test</button> -->
     
     <center id="container"><table  id="complianed" lay-filter="filter1"></table></center>
</body>
<script  src="/static/layui/layui.js" ></script>
<script src="/static/jquery/jquery.min.js"></script>
<script>
    // https://www.jianshu.com/p/1841b6e3ad86
    collection_trained = ''
    model = 'sgd'

    render_form_trained()
    function pred(){
        var data_all = document.getElementById("data_all").files
            if (data_all.length== 0 || collection_trained==""){
                layui.use('layer', function(){
                    var layer = layui.layer;
                    layer.open({
                        title: '错误',
                        content: '请上传所有文件,并选择训练数据' //这里content是一个普通的String
                    });
                });
            }else{
                layui.use('layer', function(){
                    var layer = layui.layer;
                    layer.confirm("用户信息文件:"+data_all[0].name+"\n是否上传?",
                        function(index){
                            layer.close(index);
                            layer.msg("正在上传文件，返回结果前请勿关闭窗口...")
                            var formData = new FormData($('#upload_form')[0]);
                            layui.use('table', function(){
                                var table = layui.table;
                                var height = window.innerHeight -300
                                table.render({
                                    elem: '#complianed'
                                    ,height: height
                                    ,url: 'http://phoneusersprober.com:5000/predict/api/v1.0/' //数据接口
                                    ,method: 'POST'
                                    ,where: formData
                                    ,contentType:'application/json'
                                    ,page: true //开启分页
                                    ,parseData: function(res){ //res 即为原始返回的数据
                                        return {
                                        "code": res.result, //解析接口状态/
                                        "msg": "", //解析提示文本
                                        "count": NaN, //解析数据长度
                                        "data": res.data //解析数据列表
                                        };
                                    }
                                    ,cols: [[ //表头 
                                        {field: 'feature', title: '特征',width:100}
                                        // ,{field: 'zero', title: '0', }
                                        // ,{field: 'one', title: '1', }
                                        // ,{field: 'all', title: 'all', }
                                        // ,{field: 'zero_all', title: '0/all', }
                                        // ,{field: 'one_all', title: '1/all', }
                                    ]]
                                });
                                
                            })
                            // form_data['model'] = model
                            // form_data['trained'] = collection_trained
                            // $.ajax({
                            //     url:'http://localhost:5000/predict/api/v1.0/',
                            //     type:'post',
                            //     data: formData,
                            //     cache: false,
                            //     processData: false,
                            //     contentType: false,
                            //     success:function(res){
                            //         console.log(res)
                            //         // var image = new Image();
                            //         // image.src ='data:image/png;base64,'+res;
                            //         // var container = document.getElementById('container')
                            //         // container.appendChild(image);     
                            // },
                            //     error:function(){
                            //         alert("上传失败，未知错误")
                            //     },
                            // })
                        
                    });
                });
            }
        // alert(collection_trained+collection_pred)
    //    if(collection_trained == collection_pred){
    //         layui.use('layer', function(){
    //             var layer = layui.layer;
    //             layer.alert('名称相同', function(index){
    //             layer.close(index);
    //             });
    //         });
    //         return false
    //    }else if(collection_trained!='' && collection_pred != ''){
    //         var confirm = "确定?"
    //         layer.confirm(confirm, function(index){
    //             layer.close(index);
    //             var form_data = JSON.stringify({'trained':collection_trained,
    //                                             'pred':collection_pred,
    //                                             'model':model})
    //                 $.ajax({
    //                     url:'http://localhost:5000/predict/api/v1.0/',
    //                     type:'post',
    //                     data: form_data,
    //                     cache: false,
    //                     processData: false,
    //                     contentType: false,
    //                     success:function(res){
    //                         console.log(res['data'])
    //                         // var image = new Image();
    //                         // image.src ='data:image/png;base64,'+res;
    //                         // var container = document.getElementById('container')
    //                         // container.appendChild(image);     
    //                     },
    //                     error:function(){
    //                         alert("上传失败，未知错误")
    //                     },
    //             })
    //         });
    //     }
    }
    function file_click(id) {
            input = document.getElementById(id)
            input.click()
        }
    // function render_form_pred(){
    //     $.ajax({
    //         url:'http://localhost:5000/data-center/api/v1.0/data/info',
    //         type:'get',
    //         cache: false,
    //         processData: false,
    //         contentType: false,
    //         success:function(res){
    //             var res = JSON.stringify(res)
    //             data_all = JSON.parse(res).data
    //             // data_all = JSON.parse(raw)
                
    //             //数据集的select
    //             for (let i = -1; i < data_all.length; i++) {
    //                 const element = data_all[i];
    //                 var select = document.getElementById('predicting')
    //                 var option = document.createElement('option')
    //                 if(i!=-1){
    //                     option.value = i
    //                     option.innerText = element['name']
    //                 }
    //                 select.appendChild(option)
    //             }
    //             layui.use('form', function (data) {
    //                 var form = layui.form; 
    //                 form.on('select(category)', function (data) {
    //                     var index = data.value;
    //                     var name = data.elem[data.elem.selectedIndex].text;
    //                     collection_pred = name
    //                 });
    //             })
                       
    //         },
    //         error:function(){
    //             // var res = JSON.stringify(res['msg'])
    //             alert("获取数据失败")
    //         },
    //     })
        
    // }
    function render_form_trained(){
        var form_data = JSON.stringify({'model':model})
        $.ajax({
        url:'http://phoneusersprober.com:5000/train/api/v1.0/all-collection-model',
            type:'post',
            data:form_data,
            cache: false,
            processData: false,
            contentType: false,
            success:function(res){
                var res = JSON.stringify(res)
                data_all = JSON.parse(res).data
                // data_all = JSON.parse(raw)
                
                //数据集的select
                for (let i = -1; i < data_all.length; i++) {
                    const element = data_all[i];
                    var select = document.getElementById('trained')
                    var option = document.createElement('option')
                    if(i!=-1){
                        option.value = i
                        option.innerText = element['name']
                    }
                    select.appendChild(option)
                }
                layui.use('form', function (data) {
                    var form = layui.form; 
                    form.on('select(category0)', function (data) {
                        var index = data.value;
                        var name = data.elem[data.elem.selectedIndex].text;
                        collection_trained = name
                        document.getElementById('collection').value = collection_trained
                    });
                })
                       
            },
            error:function(){
                // var res = JSON.stringify(res['msg'])
                alert("获取数据失败")
            },
        })
        
    }
 
</script>
</body>
</html>